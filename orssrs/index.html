<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ORS / SRS — Anonymous Copy (CSV)</title>
<style>
  :root {
    --bg: #f6f7fb;
    --card: #ffffff;
    --ink: #111;
    --muted: #6b7280;
    --line: #e5e7eb;
    --brand: #1f2937;
    --brand-weak: #e8eaef;
    --padX: 10px;              /* horizontal padding for slider track */
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  }
  html, body { background: var(--bg); color: var(--ink); margin:0; line-height:1.6; }
  .shell { max-width: 820px; margin: 24px auto 48px; padding: 0 16px; }
  .card { background: var(--card); border-radius: 16px; box-shadow: 0 6px 24px rgba(0,0,0,.06); padding: 20px 18px; }
  h1 { font-size: 22px; margin: 0 0 8px; letter-spacing: 0.02em; }
  .sub { color: var(--muted); font-size: 13px; margin-bottom: 12px; }

  /* Segmented control */
  .tabs { display:inline-flex; gap:0; background:#f1f3f5; border-radius:9999px; padding:4px; }
  .tab { appearance:none; border:0; background:transparent; padding:8px 16px; font-size:14px; border-radius:9999px; cursor:pointer; transition:.2s; line-height:1; }
  .tab[aria-selected="true"] { background:#111; color:#fff; }
  .tab[aria-selected="false"] { color:#111; opacity:.55; }
  .tab:focus-visible { outline:2px solid #4b9cff; outline-offset:2px; }

  /* Meta row */
  .meta { display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin:20px 0 6px; }
  .input { display:flex; flex-direction:column; gap:6px; }
  .input label { font-size:12px; color:var(--muted); }
  .input input { border:1px solid var(--line); border-radius:10px; padding:10px 12px; font-size:14px; background:#fff; }

  /* Question blocks */
  .block { padding:22px 0; border-bottom:1px solid var(--line); }
  .block:last-child { border-bottom:0; }
  .qlabel { font-size:16px; margin-bottom:10px; }

  /* Slider wrapper gives equal left/right padding for the coloured bar */
.scale { padding: 0 10px; }  /* adjust 10px to taste */

/* Base range styles */
input[type="range"]{
  -webkit-appearance:none; appearance:none;
  width:100%;
  height:28px;              /* larger touch target */
  background: transparent;  /* track draws the colour */
  border-radius: 9999px;
}

/* STATIC red→green gradient track (long pill) */
input[type="range"]::-webkit-slider-runnable-track{
  height:10px;
  border-radius:9999px;
  background: linear-gradient(to right,
    #ef4444 0%,
    #f59e0b 50%,
    #22c55e 100%);
}
input[type="range"]::-moz-range-track{
  height:10px;
  border-radius:9999px;
  background: linear-gradient(to right,
    #ef4444 0%,
    #f59e0b 50%,
    #22c55e 100%);
}

/* Thumb — colour will be set via --heat-color from JS */
input[type="range"]::-webkit-slider-thumb{
  -webkit-appearance:none; appearance:none;
  width:20px; height:20px; margin-top:-5px;  /* centers on 10px track */
  border-radius:50%;
  background: var(--heat-color, #111);
  border:2px solid #fff;
  box-shadow:0 1px 3px rgba(0,0,0,.2);
}
input[type="range"]::-moz-range-thumb{
  width:20px; height:20px; border-radius:50%;
  background: var(--heat-color, #111);
  border:2px solid #fff;
  box-shadow:0 1px 3px rgba(0,0,0,.2);
}

/* Big numeric readout (tinted to match thumb colour) */
.val{
  font-size:22px;
  font-weight:600;
  text-align:right;
  margin-top:8px;
  color: var(--heat-color, #111);
}
  /* Footer / actions */
  .totals { display:flex; justify-content:space-between; align-items:center; margin-top:16px; font-weight:600; }
  .copyrow { display:flex; flex-wrap:wrap; gap:10px; margin-top:20px; }
  button { cursor:pointer; border:0; padding:10px 14px; border-radius:10px; font-size:14px; background:var(--brand); color:#fff; }
  button.secondary { background:var(--brand-weak); color:var(--ink); }
  .opts { display:flex; align-items:center; gap:10px; color:var(--muted); font-size:13px; }

  .preview-wrap { margin-top:10px; }
  .preview { width:100%; min-height:60px; border:1px dashed var(--line); border-radius:10px; padding:8px 10px; font-size:13px; color:#333; }

  @media (max-width: 640px) { .meta { grid-template-columns:1fr; } }
</style>
</head>
<body>
  <div class="shell">
    <div class="card">
  <div class="flex items-center gap-4">
<a href="../" aria-label="Go to assessments home">
  <img src="../assets/img/nos-logo.png" alt="National Online School logo" class="h-12 w-auto">
</a>
  </div>  
    <h1>Wellbeing and Session Feedback Sliders</h1>
      <div class="sub">Please complete the ORS at the start of our session, and the SRS at the end.</div>

      <div class="tabs" role="tablist" aria-label="Form picker">
        <button id="tab-ors" class="tab" role="tab" aria-selected="true" aria-controls="panel-ors">ORS (start)</button>
        <button id="tab-srs" class="tab" role="tab" aria-selected="false" aria-controls="panel-srs">SRS (end)</button>
      </div>
      <p id="modeBlurb" class="sub"></p>

      <div class="meta">
        <div class="input">
          <label for="groupId">Group code (optional)</label>
          <input id="groupId" autocomplete="off" />
        </div>
        <div class="input">
          <label for="sessionId">Session number or date (optional)</label>
          <input id="sessionId" autocomplete="off" />
        </div>
        <div class="input">
          <label for="aliasId">Name</label>
          <input id="aliasId" autocomplete="off" />
        </div>
      </div>

      <div id="questions"></div>

      <div class="totals">
        <div>Total: <span id="total">0.00</span> / 40.00</div>
        <div class="opts">
          <label><input type="checkbox" id="includeHeader" /> include header</label>
          <label><input type="checkbox" id="showPreview" /> show preview</label>
        </div>
      </div>

      <div class="copyrow">
        <button id="copyCsvBtn">Copy answers (CSV)</button>
        <button class="secondary" id="copyReadableBtn" type="button">Copy readable text</button>
        <button class="secondary" id="clearBtn" type="button">Clear sliders</button>
      </div>

      <div id="previewWrap" class="preview-wrap" style="display:none;">
        <textarea id="preview" class="preview" readonly></textarea>
      </div>

      <textarea id="scratch" style="position:absolute;left:-9999px;top:-9999px;height:1px;width:1px;"></textarea>
    </div>
  </div>

<script>
  /* ===== Data ===== */
  const SETS = {
    ORS: [
      { key: "ORS1", label: "Individual (Personal wellbeing)" },
      { key: "ORS2", label: "Interpersonal (Family, close relationships)" },
      { key: "ORS3", label: "Social (Work, school, friendships)" },
      { key: "ORS4", label: "Overall (General sense of wellbeing)" },
    ],
    SRS: [
      { key: "SRS1", label: "Relationship (I felt heard, understood, respected)" },
      { key: "SRS2", label: "Goals/Topics (We worked on what I wanted)" },
      { key: "SRS3", label: "Approach/Method (The way felt right for me)" },
      { key: "SRS4", label: "Overall (Overall, today was right for me)" },
    ]
  };

  /* ===== DOM ===== */
  const qsEl = document.getElementById('questions');
  const totalEl = document.getElementById('total');
  const groupId = document.getElementById('groupId');
  const sessionId = document.getElementById('sessionId');
  const aliasId = document.getElementById('aliasId');
  const includeHeaderEl = document.getElementById('includeHeader');
  const showPreviewEl = document.getElementById('showPreview');
  const previewWrap = document.getElementById('previewWrap');
  const preview = document.getElementById('preview');
  const modeBlurb = document.getElementById('modeBlurb');
  const tabOrs = document.getElementById('tab-ors');
  const tabSrs = document.getElementById('tab-srs');

  /* ===== Storage ===== */
  const STORAGE_KEY = 'orssrs_state_v1';
  function defaultState(){ return { ORS:[0,0,0,0], SRS:[0,0,0,0], meta:{group:'',session:'',alias:''} }; }
  function getState(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)) || defaultState(); } catch(e){ return defaultState(); } }
  function saveState(s){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(s)); } catch(e){} }

  /* ===== Heat helpers ===== */
  // Map value 0..10 to red→green
  function heatColor(val, max = 10){
    const ratio = Math.min(Math.max(val / max, 0), 1); // clamp 0..1
    const hue = 120 * ratio;                            // 0=red,120=green
    return `hsl(${hue} 70% 40%)`;
  }

  // Apply colour to thumb + number (no dynamic track fill)
  function applyHeatColor(rangeEl){
    const max = parseFloat(rangeEl.max) || 10;
    const v   = parseFloat(rangeEl.value) || 0;
    const col = heatColor(v, max);
    rangeEl.style.setProperty('--heat-color', col);

    const readout = document.getElementById(rangeEl.id + '-val');
    if (readout){
      readout.textContent = v.toFixed(2);
      readout.style.color = col;
    }
  }

  /* ===== Rendering ===== */
  function render(mode){
    const state = getState();
    qsEl.innerHTML = '';
    SETS[mode].forEach((q, idx) => {
      const val = Number((state[mode] || [])[idx] ?? 0);
      const block = document.createElement('div');
      block.className = 'block';
      block.innerHTML = `
        <div class="qlabel"><strong>${mode} ${idx+1}.</strong> ${q.label}</div>
        <div class="scale">
          <input data-idx="${idx}" type="range" min="0" max="10" step="0.01" value="${val}" id="${q.key}" aria-label="${q.label}" />
          <div class="val"><span id="${q.key}-val">${val.toFixed(2)}</span></div>
        </div>
      `;
      qsEl.appendChild(block);
    });

    // seed meta inputs
    const st = getState();
    groupId.value   = st.meta.group || '';
    sessionId.value = st.meta.session || '';
    aliasId.value   = st.meta.alias || '';

    // initialise thumb + number colours for all sliders
    qsEl.querySelectorAll('input[type="range"]').forEach(applyHeatColor);

    bindRanges();
    updateTotal();
    maybeUpdatePreview();
  }

  /* ===== Events ===== */
  function bindRanges(){
    qsEl.querySelectorAll('input[type="range"]').forEach(r => {
      r.addEventListener('input', () => {
        const v = Number(r.value);

        // persist
        const mode = getMode();
        const state = getState();
        const idx = Number(r.getAttribute('data-idx'));
        (state[mode] ||= [0,0,0,0])[idx] = v;
        saveState(state);

        // refresh thumb tint + big number
        applyHeatColor(r);

        updateTotal();
        maybeUpdatePreview();
      });
    });
  }

  [groupId, sessionId, aliasId].forEach(el => {
    el.addEventListener('input', () => {
      const st = getState();
      st.meta.group   = groupId.value.trim();
      st.meta.session = sessionId.value.trim();
      st.meta.alias   = aliasId.value.trim();
      saveState(st);
      maybeUpdatePreview();
    });
  });

  function getMode(){ return tabOrs.getAttribute('aria-selected') === 'true' ? 'ORS' : 'SRS'; }

  function setTab(isORS){
    tabOrs.setAttribute('aria-selected', isORS ? 'true' : 'false');
    tabSrs.setAttribute('aria-selected', isORS ? 'false' : 'true');
    render(isORS ? 'ORS' : 'SRS');
    updateBlurb();
  }

  tabOrs.addEventListener('click', () => setTab(true));
  tabSrs.addEventListener('click', () => setTab(false));

  function updateBlurb(){
    const isORS = tabOrs.getAttribute('aria-selected') === 'true';
    modeBlurb.textContent = isORS
      ? "Looking back over the last week, including today, help me understand how you have been feeling by rating how well you have been doing in the following areas of your life:"
      : "Please rate today's session by sliding the scale to the description that best fits your experience.";
  }

  /* ===== Totals & Copy ===== */
  function currentValues(){
    const vals = [];
    qsEl.querySelectorAll('input[type="range"]').forEach(r => vals.push(Number(r.value || 0)));
    return vals;
  }
  function updateTotal(){
    const sum = currentValues().reduce((a,b)=>a+b,0);
    totalEl.textContent = sum.toFixed(2);
  }

  function buildCSV(includeHeader=false){
    const dt = new Date().toISOString().slice(0,10);
    const name = aliasId.value.trim(); // Pupil
    const g = groupId.value.trim();
    const s = sessionId.value.trim();

    const st = getState();
    const orsVals = (st.ORS || [0,0,0,0]).map(v => Number(v).toFixed(2));
    const srsVals = (st.SRS || [0,0,0,0]).map(v => Number(v).toFixed(2));
    const orsTotal = orsVals.reduce((a,b)=>a + parseFloat(b), 0).toFixed(2);
    const srsTotal = srsVals.reduce((a,b)=>a + parseFloat(b), 0).toFixed(2);

    const header = ['Pupil','Group Code','Session No.','Date','ORS_1','ORS_2','ORS_3','ORS_4','ORS_T','SRS_1','SRS_2','SRS_3','SRS_4','SRS_T'];
    const row = [name,g,s,dt, ...orsVals, orsTotal, ...srsVals, srsTotal];

    const joiner = ', ';
    const out = [];
    if (includeHeader) out.push(header.join(joiner));
    out.push(row.join(joiner));
    return out.join('\n');
  }

  function buildReadable(){
    const mode = getMode();
    const dt = new Date().toISOString().slice(0,10);
    const g = groupId.value.trim();
    const s = sessionId.value.trim();
    const a = aliasId.value.trim();

    const lines = [`Form: ${mode}`, `Date: ${dt}`];
    if (g) lines.push(`Group: ${g}`);
    if (s) lines.push(`Session: ${s}`);
    if (a) lines.push(`Alias: ${a}`);
    lines.push('Answers:');

    const set = SETS[mode];
    let total = 0;
    set.forEach((q, i) => {
      const v = Number(document.getElementById(q.key).value || 0);
      total += v;
      lines.push(`${mode}${i+1}: ${v.toFixed(2)}`);
    });
    lines.push(`Total: ${total.toFixed(2)}`);
    return lines.join('\n');
  }

  async function copyText(text){
    if (navigator.clipboard && window.isSecureContext) {
      try { await navigator.clipboard.writeText(text); return true; } catch(e){}
    }
    const ta = document.createElement('textarea');
    ta.value = text; ta.setAttribute('readonly',''); ta.style.position='fixed'; ta.style.top='0'; ta.style.left='0'; ta.style.opacity='0'; ta.style.pointerEvents='none';
    document.body.appendChild(ta); ta.focus(); ta.select();
    let ok=false; try{ ok=document.execCommand('copy'); }catch(e){ ok=false; }
    document.body.removeChild(ta);
    return ok;
  }

  function maybeUpdatePreview(){ if (showPreviewEl.checked) preview.value = buildCSV(includeHeaderEl.checked); }

  document.getElementById('copyCsvBtn').addEventListener('click', async () => {
    const text = buildCSV(includeHeaderEl.checked);
    const ok = await copyText(text);
    if (!ok) { previewWrap.style.display='block'; preview.value=text; alert('Copy failed. The CSV is shown below. Select all and copy.'); }
    else if (showPreviewEl.checked) preview.value = text;
  });
  document.getElementById('copyReadableBtn').addEventListener('click', async () => {
    const text = buildReadable();
    const ok = await copyText(text);
    if (!ok) { previewWrap.style.display='block'; preview.value=text; alert('Copy failed. The text is shown below. Select all and copy.'); }
    else if (showPreviewEl.checked) preview.value = text;
  });

  document.getElementById('clearBtn').addEventListener('click', () => {
    const mode = getMode();
    const st = getState();
    st[mode] = [0,0,0,0];
    saveState(st);
    qsEl.querySelectorAll('input[type="range"]').forEach(r => { r.value = 0; applyHeatColor(r); });
    updateTotal(); maybeUpdatePreview();
  });

  includeHeaderEl.addEventListener('change', maybeUpdatePreview);
  showPreviewEl.addEventListener('change', () => { previewWrap.style.display = showPreviewEl.checked ? 'block' : 'none'; maybeUpdatePreview(); });

  /* ===== Init ===== */
  setTab(true);  // default ORS
  const params = new URLSearchParams(location.search);
  if ((params.get('mode') || '').toUpperCase() === 'SRS') setTab(false);
  updateBlurb();
</script>
</body>
</html>
