<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SDQ Screener</title>
  <script src="https://cdn.tailwindcss.com"></script>
    <style>
    /* Large, clickable choice boxes */
    input[type="radio"]:checked + label {
      background-color: #4f46e5;
      color: white;
      border-color: #4f46e5;
    }
    label.choice {
      cursor: pointer;
      padding: 0.5rem 1rem;
      border: 1px solid #e5e7eb;
      border-radius: 0.75rem;
      font-size: 0.9rem;
      user-select: none;
    }
    @media print {
    body { background: #fff !important; }
    /* Hide just the action buttons/links */
    .no-print { display: none !important; }
    /* Tidy container for print */
    #reportContainer { box-shadow: none; padding: 0; }
    /* Avoid awkward row splits */
    table { break-inside: auto; }
    tr, td, th { break-inside: avoid; page-break-inside: avoid; }
    h1, h2, h3 { page-break-after: avoid; }
  }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-6">
  <div class="max-w-6xl mx-auto bg-white p-8 rounded-2xl shadow-xl" id="reportContainer">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
      <a href="../index.html" class="inline-flex items-center gap-3">
  <img src="../assets/img/nos-logo.png" alt="National Online School" class="h-12 w-auto" />
  <span class="sr-only">Back to Assessments</span>
</a>
      <h1 class="text-3xl font-bold text-gray-800">Strengths and Difficulties Questionnaire</h1>
    </div>

    <!-- Form -->
    <form id="sdqForm" class="space-y-6">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-2">
        <input type="text" name="pupilName" placeholder="Pupil Full Name" required class="p-2 border rounded w-full" />
        <input type="date" name="dob" required class="p-2 border rounded w-full" />
        <input type="text" name="completedBy" placeholder="Completed by (Name)" required class="p-2 border rounded w-full" />
        <input type="text" name="position" placeholder="Position (e.g., Teacher, Therapist)" required class="p-2 border rounded w-full" />
      </div>

      <div class="flex justify-end">
        <button type="button" onclick="resetForm()" class="mb-4 px-4 py-1 bg-gray-300 text-gray-800 rounded">Reset Form</button>
      </div>

      <table class="min-w-full table-auto border-collapse">
        <thead>
          <tr class="bg-indigo-100 text-gray-800">
            <th class="text-left px-4 py-2">Question</th>
            <th class="text-center px-4 py-2">Choices</th>
          </tr>
        </thead>
        <tbody id="questionContainer" class="bg-white divide-y divide-gray-200"></tbody>
      </table>

      <div class="mt-6">
        <h3 class="font-semibold text-gray-700 mb-2">Impact Supplement</h3>
        <div class="space-y-4">
          <div>
            <label class="block mb-1">Do the difficulties upset or distress the child?</label>
            <select name="impact1" required class="rounded border p-2 w-full">
              <option value="0">Not at all</option>
              <option value="1">Only a little</option>
              <option value="2">Quite a lot</option>
              <option value="3">A great deal</option>
            </select>
          </div>
          <div>
            <label class="block mb-1">Do they interfere with peer relationships?</label>
            <select name="impact2" required class="rounded border p-2 w-full">
              <option value="0">Not at all</option>
              <option value="1">Only a little</option>
              <option value="2">Quite a lot</option>
              <option value="3">A great deal</option>
            </select>
          </div>
          <div>
            <label class="block mb-1">Do they interfere with classroom learning?</label>
            <select name="impact3" required class="rounded border p-2 w-full">
              <option value="0">Not at all</option>
              <option value="1">Only a little</option>
              <option value="2">Quite a lot</option>
              <option value="3">A great deal</option>
            </select>
          </div>
        </div>
      </div>

      <div class="flex items-center gap-3 mt-6">
        <button type="submit" class="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-xl">Submit</button>
      </div>
    </form>

    <!-- Results -->
    <div id="results" class="mt-10 hidden">
      <h2 class="text-xl font-bold mb-4">Results</h2>
      <table class="table-auto border w-full text-sm text-left mb-4">
        <thead class="bg-gray-100">
          <tr>
            <th class="border px-4 py-2">Subscale</th>
            <th class="border px-4 py-2">Score</th>
            <th class="border px-4 py-2">Interpretation</th>
          </tr>
        </thead>
        <tbody id="subscaleResults"></tbody>
      </table>
      <pre id="csvOutput" class="bg-gray-100 p-4 rounded text-sm overflow-auto"></pre>
      <div class="flex gap-3 mt-2 no-print">
        <button type="button" onclick="downloadCSV()" class="px-4 py-2 bg-blue-600 text-white rounded">Download CSV</button>
        <button type="button" onclick="printWholeDoc()" class="px-4 py-2 bg-red-600 text-white rounded no-print">
  Print / Save as PDF
</button>
    </div>
  </div>

  <script>
    // --- SDQ items (25) ---
    const questions = [
      "Considerate of other people’s feelings",
      "Restless, overactive, cannot stay still for long",
      "Often complains of headaches, stomach-aches or sickness",
      "Shares readily with other children (toys, treats, pencils etc.)",
      "Often loses temper",
      "Rather solitary, tends to play alone",
      "Generally obedient, usually does what adults request",
      "Many worries, often seems worried",
      "Helpful if someone is hurt, upset or feeling ill",
      "Constantly fidgeting or squirming",
      "Has at least one good friend",
      "Often fights with other children or bullies them",
      "Often unhappy, down-hearted or tearful",
      "Generally liked by other children",
      "Easily distracted, concentration wanders",
      "Nervous or clingy in new situations, easily loses confidence",
      "Kind to younger children",
      "Often lies or cheats",
      "Picked on or bullied by other children",
      "Often volunteers to help others (parents, teachers, children)",
      "Thinks things out before acting",
      "Steals from home, school or elsewhere",
      "Gets along better with adults than with other children",
      "Many fears, easily scared",
      "Sees tasks through to the end, good attention span"
    ];

    // --- SDQ subscale item indices ---
    const subscales = {
      Emotional: [3, 8, 13, 16, 24],
      Conduct: [5, 7, 12, 18, 22],
      Hyperactivity: [2, 10, 15, 21, 25],
      Peer: [6, 11, 14, 19, 23],
      Prosocial: [1, 4, 9, 17, 20]
    };

    // --- Interpretation bands (Teacher 4–17 from your sheet) ---
    // For non-Prosocial: Close<=A, Slightly<=B, High<=C, else Very High
    const bands = {
      Total: [11, 15, 18],
      Emotional: [3, 4, 5],
      Conduct: [2, 3, 4],
      Hyperactivity: [5, 7, 8],
      Peer: [2, 4, 5]
      // Prosocial handled separately (reverse)
    };

    function interpret(scale, score) {
      if (scale === 'Prosocial') {
        if (score >= 6) return 'Close to Avg';
        if (score === 5) return 'Slightly Low';
        if (score === 4) return 'Low';
        return 'Very Low'; // 0–3
      }
      const [closeMax, slightMax, highMax] = scale === 'Total' ? bands.Total : bands[scale];
      if (score <= closeMax) return 'Close to Avg';
      if (score <= slightMax) return 'Slightly Raised';
      if (score <= highMax) return 'High';
      return 'Very High';
    }

    // Build questions & prefill from sessionStorage on load
    window.addEventListener('DOMContentLoaded', () => {
      // Prefill assessor details
      document.querySelector('[name="pupilName"]').value = sessionStorage.getItem('pupilName') || '';
      document.querySelector('[name="dob"]').value = sessionStorage.getItem('dob') || '';
      document.querySelector('[name="completedBy"]').value = sessionStorage.getItem('completedBy') || '';
      document.querySelector('[name="position"]').value = sessionStorage.getItem('position') || '';

      // Render SDQ rows (card-style radios)
      const container = document.getElementById('questionContainer');
      container.innerHTML = '';
      for (let i = 1; i <= 25; i++) {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="px-4 py-2 align-top">${i}. ${questions[i - 1]}</td>
          <td class="px-4 py-2">
            <div class="flex gap-2 justify-center">
              ${[0,1,2].map(v => `
                <input type="radio" name="SDQ${i}" id="SDQ${i}_${v}" value="${v}" class="hidden" required>
                <label for="SDQ${i}_${v}" class="choice">${['Not True','Somewhat True','Certainly True'][v]}</label>
              `).join('')}
            </div>
          </td>`;
        container.appendChild(row);
      }
    });

    // Submit handler (clean, robust)
    document.getElementById('sdqForm').addEventListener('submit', function(e) {
      e.preventDefault();

      const form = e.target;
      const formData = new FormData(form);

      // Persist assessor details for the day
      sessionStorage.setItem('pupilName', formData.get('pupilName'));
      sessionStorage.setItem('dob', formData.get('dob'));
      sessionStorage.setItem('completedBy', formData.get('completedBy'));
      sessionStorage.setItem('position', formData.get('position'));

      // Collect item scores (validate all answered)
      const scores = {};
      for (let i = 1; i <= 25; i++) {
        const v = formData.get(`SDQ${i}`);
        if (v === null) { alert('Please answer all questions.'); return; }
        scores[`SDQ${i}`] = Number(v);
      }

      // Impact
      const impactKeys = ['impact1','impact2','impact3'];
      const impact = impactKeys.reduce((sum, key) => sum + Number(formData.get(key)), 0);

      // Subscale totals
      const totals = {};
      for (const [scale, idxs] of Object.entries(subscales)) {
        totals[scale] = idxs.reduce((a, i) => a + scores[`SDQ${i}`], 0);
      }
      const totalDiff = totals.Emotional + totals.Conduct + totals.Hyperactivity + totals.Peer;

      // Results table
      const tbody = document.getElementById('subscaleResults');
      tbody.innerHTML = '';
      for (const [scale, val] of Object.entries(totals)) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class='border px-4 py-2'>${scale}</td><td class='border px-4 py-2'>${val}</td><td class='border px-4 py-2'>${interpret(scale, val)}</td>`;
        tbody.appendChild(tr);
      }
      const trTotal = document.createElement('tr');
      trTotal.innerHTML = `<td class='border px-4 py-2 font-bold'>Total Difficulties</td><td class='border px-4 py-2 font-bold'>${totalDiff}</td><td class='border px-4 py-2 font-bold'>${interpret('Total', totalDiff)}</td>`;
      tbody.appendChild(trTotal);
      const trImpact = document.createElement('tr');
      trImpact.innerHTML = `<td class='border px-4 py-2'>Impact Score</td><td class='border px-4 py-2'>${impact}</td><td class='border px-4 py-2'>${impact >= 3 ? 'Notable Impact' : 'Low/No Impact'}</td>`;
      tbody.appendChild(trImpact);

      // CSV output (build BEFORE chart so errors in chart never block it)
      const dateStr = new Date().toISOString().split('T')[0];
      const sanitize = (s) => (s || '').toString().replace(/,/g, ' ');
      const headers = [
        'Date','Pupil Name','DOB','Completed By','Position',
        ...Array.from({length:25}, (_,i)=>`SDQ${i+1}`),
        'Emotional','Conduct','Hyperactivity','Peer','Prosocial','Total Difficulties','Impact Score'
      ];
      const values = [
        dateStr,
        sanitize(formData.get('pupilName')),
        sanitize(formData.get('dob')),
        sanitize(formData.get('completedBy')),
        sanitize(formData.get('position')),
        ...Array.from({length:25}, (_,i)=>scores[`SDQ${i+1}`]),
        totals.Emotional, totals.Conduct, totals.Hyperactivity, totals.Peer, totals.Prosocial,
        totalDiff, impact
      ];
      const csv = `${headers.join(',')}\n${values.join(',')}`;
      document.getElementById('csvOutput').textContent = csv;

      // Reveal results first (buttons are inside #results)
      const resultsEl = document.getElementById('results');
      resultsEl.classList.remove('hidden');
      resultsEl.scrollIntoView({behavior:'smooth'});
    });
function printWholeDoc() {
    const results = document.getElementById('results');
    const wasHidden = results.classList.contains('hidden');
    // Ensure all sections are visible for print
    if (wasHidden) results.classList.remove('hidden');
    // Give the browser a tick to reflow, then print
    setTimeout(() => {
      window.print();
      // Restore prior state after print if needed
      if (wasHidden) results.classList.add('hidden');
    }, 50);
  }
    function downloadCSV() {
      const csv = document.getElementById('csvOutput').textContent || '';
      if (!csv.trim()) { alert('Please complete and submit the form first.'); return; }
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      const pupil = (sessionStorage.getItem('pupilName') || 'sdq').replace(/\W+/g,'_');
      a.download = `${pupil}_sdq_${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function resetForm() {
      document.getElementById('sdqForm').reset();
      sessionStorage.clear();
      // Clear results and chart to avoid stale data on print
      const tbody = document.getElementById('subscaleResults');
      if (tbody) tbody.innerHTML = '';
      document.getElementById('csvOutput').textContent = '';
      const resultsEl = document.getElementById('results');
      resultsEl.classList.add('hidden');
      window.scrollTo({top: 0, behavior: 'smooth'});
    }
  </script>
</body>
</html>
